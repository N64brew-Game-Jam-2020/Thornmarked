load("@rules_cc//cc:defs.bzl", "cc_binary")
load("//base:copts.bzl", "COPTS")

alias(
    name = "game",
    actual = ":Thornmarked",
)

cc_binary(
    name = "Thornmarked.elf",
    srcs = [
        "corelib.h",
        "defs.h",
        "fatal.c",
        "main.c",
        "memset.c",
        "scheduler.c",
        "scheduler.h",
        "stack.s",
        "text.c",
    ],
    additional_linker_inputs = ["//n64:link.lds"],
    copts = COPTS + ["-ffreestanding"],
    defines = ["F3DEX_GBI_2"],
    linkopts = [
        "-T",
        "$(location //n64:link.lds)",
    ],
    deps = [
        "//assets",
        "//assets/fonts/terminus:ter-u12n",
        "//base:defs",
        "//base:random",
        "//n64",
        "@n64sdk//:gspF3DEX2.xbus",
        "@n64sdk//:rspboot",
    ],
)

genrule(
    name = "Thornmarked",
    srcs = [
        ":Thornmarked.elf",
        "//assets:assets.dat",
    ],
    outs = ["Thornmarked.n64"],
    cmd = ("mips32-elf-objcopy -O binary $(location :Thornmarked.elf) $@; " +
           "cat $(location //assets:assets.dat) >>$@; " +
           "makemask $@"),
)
